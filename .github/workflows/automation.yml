name: Merge Submodule PRs

on:
  pull_request:
    types: [closed, labeled] 

jobs:
  merge-submodules:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Extract Branch Name
        run: echo "BRANCH_NAME=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV

      - name: Merge PR in ee-server (if exists)
        run: |
          PR=$(gh pr list -R adishM98/server-ee-testing --head "$BRANCH_NAME" --state open --json number -q '.[0].number')
          if [ -n "$PR" ]; then
            echo "Found ee-server PR: #$PR"
            gh pr merge -R adishM98/server-ee-testing "$PR" --merge --admin
          else
            echo "No open ee-server PR for branch $BRANCH_NAME"
          fi
        env:
          GH_TOKEN: ${{ secrets.TOKEN_PR }}

      - name: Merge PR in ee-frontend (if exists)
        run: |
          PR=$(gh pr list -R adishM98/frontend-ee-testing --head "$BRANCH_NAME" --state open --json number -q '.[0].number')
          if [ -n "$PR" ]; then
            echo "Found ee-frontend PR: #$PR"
            gh pr merge -R adishM98/frontend-ee-testing "$PR" --merge --admin
          else
            echo "No open ee-frontend PR for branch $BRANCH_NAME"
          fi
        env:
          GH_TOKEN: ${{ secrets.TOKEN_PR }}

  check-submodule-prs:
    if: github.event.action == 'labeled' && github.event.label.name == 'pr-ready-merge'
    runs-on: ubuntu-latest

    steps:
      - name: Extract Branch Name
        run: echo "BRANCH_NAME=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV

      - name: Check and Comment Linked Submodule PRs
        run: |
          COMMENT_BODY="üîç Checking linked submodule PRs for \`$BRANCH_NAME\`:\n\n"

          SERVER_PR=$(gh pr list -R adishM98/server-ee-testing --head "$BRANCH_NAME" --state open --json number,url -q '.[0]')
          FRONTEND_PR=$(gh pr list -R adishM98/frontend-ee-testing --head "$BRANCH_NAME" --state open --json number,url -q '.[0]')

          if [ -n "$SERVER_PR" ]; then
            SERVER_URL=$(gh pr list -R adishM98/server-ee-testing --head "$BRANCH_NAME" --state open --json url -q '.[0].url')
            COMMENT_BODY+="‚úÖ [ee-server PR]($SERVER_URL)\n"
          else
            COMMENT_BODY+="‚ùå No open PR in ee-server\n"
          fi

          if [ -n "$FRONTEND_PR" ]; then
            FRONTEND_URL=$(gh pr list -R adishM98/frontend-ee-testing --head "$BRANCH_NAME" --state open --json url -q '.[0].url')
            COMMENT_BODY+="‚úÖ [ee-frontend PR]($FRONTEND_URL)\n"
          else
            COMMENT_BODY+="‚ùå No open PR in ee-frontend\n"
          fi

          gh pr comment "$PR_NUMBER" --repo adishM98/base-repo-testing --body "$COMMENT_BODY"
        env:
          GH_TOKEN: ${{ secrets.TOKEN_PR }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
